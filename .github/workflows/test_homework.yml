name: Run Homework Tests

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, edited, synchronize, ready_for_review]
    branches: [main]

jobs:
  validate-homework:
    if: ${{ github.event.pull_request.number != 1 }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Extract HW number from PR title
        id: extract_hw
        run: |
          echo "PR title: ${{ github.event.pull_request.title }}"
          if [[ "${{ github.event.pull_request.title }}" =~ Homework([0-9]+) ]]; then
            echo "Found homework number: ${BASH_REMATCH[1]}"
            echo "num=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "test_file=tests/test_hw${BASH_REMATCH[1]}.py" >> $GITHUB_OUTPUT
            echo "hw_dir=homeworks/hw${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "No HW number found in PR title. Expected format: 'HomeworkX' (e.g., Homework5)"
            exit 1
          fi

      - name: Check if homework is excluded
        id: skip_check
        run: |
          EXCLUDED_HOMEWORKS=("1" "2" "3" "15" "16" "17" "18" "19" "20" "21" "22" "23" "24" "25" "26" "27" "28" "30" "31" "32")
          HW_NUM="${{ steps.extract_hw.outputs.num }}"
          echo "Checking if homework #$HW_NUM is excluded..."
          for EXCLUDED in "${EXCLUDED_HOMEWORKS[@]}"; do
            if [[ "$HW_NUM" == "$EXCLUDED" ]]; then
              echo "Homework #$HW_NUM is excluded from testing. Skipping pytest..."
              echo "skip_tests=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "skip_tests=false" >> $GITHUB_OUTPUT

      - name: Run homework-specific tests
        if: steps.skip_check.outputs.skip_tests != 'true'
        run: |
          echo "Running tests for Homework #${{ steps.extract_hw.outputs.num }}"
          pytest ${{ steps.extract_hw.outputs.test_file }} -v --tb=short --disable-warnings